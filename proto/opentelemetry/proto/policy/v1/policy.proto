syntax = "proto3";

package opentelemetry.proto.policy.v1;

import "google/api/annotations.proto";
import "opentelemetry/proto/common/v1/common.proto";

option go_package = "github.com/open-telemetry/opentelemetry-proto/gen/go/policy/v1";
option java_multiple_files = true;
option java_package = "io.opentelemetry.proto.policy.v1";

// =============================================================================
// Common Match Targets
//
// These targets are shared across telemetry types because Resource and Scope
// exist at every level of the OTel data model.
// =============================================================================

// Matches a resource attribute by key (e.g., "service.name").
message ResourceAttributeTarget {
  string key = 1;
}

// Matches the instrumentation scope name.
message ScopeNameTarget {}

// Matches the instrumentation scope version.
message ScopeVersionTarget {}

// Matches a scope attribute by key.
message ScopeAttributeTarget {
  string key = 1;
}

// =============================================================================
// Log Match Targets
// =============================================================================

// Matches the log body content.
message LogBodyTarget {}

// Matches the log severity text (e.g., "ERROR", "WARN").
message LogSeverityTextTarget {}

// Matches the log severity number (1-24).
message LogSeverityNumberTarget {}

// Matches a log record attribute by key.
message LogAttributeTarget {
  string key = 1;
}

// =============================================================================
// Log Matcher
// =============================================================================

// LogMatcher defines a condition for matching logs.
//
// Multiple matchers are ANDed: all must match for the policy to apply.
// Uses RE2 regex syntax. Empty regex matches any value (existence check).
//
// Examples:
//
//   Match logs from payment service:
//     {resource_attribute: {key: "service.name"}, regex: "^payment-service$"}
//
//   Match ERROR severity:
//     {severity_text: {}, regex: "^ERROR$"}
//
//   Match logs containing SSN pattern:
//     {body: {}, regex: "\\b[0-9]{3}-[0-9]{2}-[0-9]{4}\\b"}
message LogMatcher {
  oneof target {
    ResourceAttributeTarget resource_attribute = 1;
    ScopeNameTarget scope_name = 2;
    ScopeVersionTarget scope_version = 3;
    ScopeAttributeTarget scope_attribute = 4;
    LogBodyTarget body = 5;
    LogSeverityTextTarget severity_text = 6;
    LogSeverityNumberTarget severity_number = 7;
    LogAttributeTarget attribute = 8;
  }

  string regex = 9;
  bool negate = 10;
}

// =============================================================================
// Log Filter
// =============================================================================

enum FilterAction {
  FILTER_ACTION_UNSPECIFIED = 0;
  FILTER_ACTION_KEEP = 1;
  FILTER_ACTION_DROP = 2;
}

// LogFilterConfig keeps or drops logs that match the conditions.
message LogFilterConfig {
  repeated LogMatcher matchers = 1;
  FilterAction action = 2;
}

// =============================================================================
// Log Redaction
// =============================================================================

// LogRedactionTarget specifies which log field to redact.
message LogRedactionTarget {
  oneof target {
    LogBodyTarget body = 1;
    LogAttributeTarget attribute = 2;
  }
}

// LogRedactionRule defines a find/replace operation.
message LogRedactionRule {
  LogRedactionTarget target = 1;
  string pattern = 2;      // Regex to find (RE2)
  string replacement = 3;  // Replacement string ($1, $2 supported)
}

// LogRedactionConfig scrubs sensitive data from logs.
message LogRedactionConfig {
  repeated LogMatcher matchers = 1;  // Scope which logs. Empty = all.
  repeated LogRedactionRule rules = 2;
}

// =============================================================================
// Log Policy
// =============================================================================

// LogPolicy defines how to process logs matching specific conditions.
message LogPolicy {
  string id = 1;
  string name = 2;
  string description = 3;

  oneof config {
    LogFilterConfig filter = 4;
    LogRedactionConfig redaction = 5;
  }

  int32 priority = 6;
  bool enabled = 7;
  repeated opentelemetry.proto.common.v1.KeyValue labels = 8;
  fixed64 created_at_unix_nano = 9;
  fixed64 modified_at_unix_nano = 10;
}

// =============================================================================
// Policy Set
// =============================================================================

// PolicySet is a versioned collection of policies from a single source.
message PolicySet {
  string id = 1;
  string name = 2;
  string version = 3;
  string source = 4;
  fixed64 timestamp_unix_nano = 5;

  repeated LogPolicy log_policies = 6;
  // repeated MetricPolicy metric_policies = 7;  // future
  // repeated SpanPolicy span_policies = 8;      // future
}

// =============================================================================
// Sync Protocol
// =============================================================================

enum TelemetryType {
  TELEMETRY_TYPE_UNSPECIFIED = 0;
  TELEMETRY_TYPE_LOGS = 1;
  TELEMETRY_TYPE_METRICS = 2;
  TELEMETRY_TYPE_TRACES = 3;
}

message ClientMetadata {
  string client_id = 1;
  string client_version = 2;
  string workspace_id = 3;
  fixed64 last_sync_timestamp_unix_nano = 4;
  repeated TelemetryType supported_telemetry_types = 5;
  repeated opentelemetry.proto.common.v1.KeyValue labels = 6;
  repeated opentelemetry.proto.common.v1.KeyValue resource_attributes = 7;
}

message SyncRequest {
  ClientMetadata client_metadata = 1;
  bool full_sync = 2;
}

message SyncResponse {
  PolicySet policy_set = 1;
  fixed64 sync_timestamp_unix_nano = 2;
  uint32 recommended_sync_interval_seconds = 3;
  bool is_full_sync = 4;
  string error_message = 5;
}

// =============================================================================
// Service
// =============================================================================

service PolicyService {
  rpc Sync(SyncRequest) returns (SyncResponse) {
    option (google.api.http) = {
      post: "/v1/policy/sync"
      body: "*"
    };
  }
}
