syntax = "proto3";

package opentelemetry.proto.policy.v1;

option go_package = "github.com/open-telemetry/opentelemetry-proto/gen/go/policy/v1";
option java_multiple_files = true;
option java_package = "io.opentelemetry.proto.policy.v1";

// =============================================================================
// Matching
// =============================================================================

// LogMatcher provides a way to match against log telemetry data using known fields.
//
// IMPORTANT CONSTRAINTS:
// - Multiple matchers are ANDed together: all matchers must match for the
//   overall match to succeed.
// - The list of matchers should uniquely identify a specific pattern of telemetry
//   for that policy. Matchers should NOT be used as a catch-all; they should be
//   specific enough to target the intended telemetry precisely.
//
// All regex fields use RE2 syntax for consistency across implementations.
message LogMatcher {
  // If true, inverts the match (matches when the field does NOT match)
  bool negate = 1;

  // The field to match against. Exactly one must be set.
  oneof match {
    // Log-specific matching
    LogBodyMatch log_body = 20;
    LogSeverityTextMatch log_severity_text = 21;
    LogAttributeMatch log_attribute = 23;

    // Future: Resource-level, scope-level, and additional log matchers will be added.
  }
}

// =============================================================================
// Log Matchers
// =============================================================================

// LogBodyMatch matches against the log record body.
message LogBodyMatch {
  // Regex pattern to match the log body content.
  string regex = 1;
}

// LogSeverityTextMatch matches against the log severity text.
message LogSeverityTextMatch {
  // Regex pattern to match the severity text (e.g., "ERROR", "WARN", "INFO").
  string regex = 1;
}

// LogAttributeMatch matches against a log record attribute by key.
message LogAttributeMatch {
  // The attribute key to match (e.g., "user.id", "http.method").
  string key = 1;

  // Regex pattern to match the attribute value. Empty matches any value (existence check).
  string regex = 2;
}

// =============================================================================
// Field Selectors
// =============================================================================

// LogTransformField selects which field of a log record to transform.
// Mirrors the structure of matcher fields but for targeting transformations.
message LogTransformField {
  oneof field {
    // Log-specific fields
    LogBodyField log_body = 20;
    LogSeverityTextField log_severity_text = 21;
    LogAttributeField log_attribute = 23;

    // Future: Resource-level and scope-level field selectors will be added.
  }
}

// Log-specific field selectors
message LogBodyField {}

message LogSeverityTextField {}

message LogAttributeField {
  // The attribute key to target (e.g., "user.id", "http.url").
  string key = 1;
}

// =============================================================================
// Replacement Configuration
// =============================================================================

// ReplacementConfig defines a sed-like replacement operation.
// Uses RE2 regex syntax for pattern matching.
message ReplacementConfig {
  // The regex pattern to match (RE2 syntax).
  string pattern = 1;

  // The replacement string. May include capture group references like $1, $2, or ${1}.
  string replacement = 2;
}
