syntax = "proto3";

package tero.policy.v1;

import "tero/policy/v1/common.proto";

option go_package = "github.com/usetero/policy/gen/go/tero/policy/v1";

// =============================================================================
// Log Target
// =============================================================================

// LogTarget defines matching and actions for logs.
message LogTarget {
  // Matchers to identify which logs this policy applies to (AND logic)
  repeated LogMatcher match = 1;

  // Sampling/keep configuration
  KeepConfig keep = 2;

  // Transform operations to apply
  LogTransform transform = 3;
}

// =============================================================================
// Log Field Selectors
// =============================================================================

// LogField identifies simple log fields.
enum LogField {
  LOG_FIELD_UNSPECIFIED = 0;
  LOG_FIELD_BODY = 1;
  LOG_FIELD_SEVERITY_TEXT = 2;
}

// LogFieldSelector selects which field of a log record to target.
message LogFieldSelector {
  oneof field {
    // Simple fields (body, severity_text)
    LogField log_field = 1;

    // Attribute by key
    string log_attribute = 2;
  }
}

// =============================================================================
// Log Matching
// =============================================================================

// LogMatcher provides a way to match against log telemetry data using known fields.
//
// IMPORTANT CONSTRAINTS:
// - Multiple matchers are ANDed together: all matchers must match for the
//   overall match to succeed.
// - The list of matchers should uniquely identify a specific pattern of telemetry
//   for that policy. Matchers should NOT be used as a catch-all; they should be
//   specific enough to target the intended telemetry precisely.
//
// All regex fields use RE2 syntax for consistency across implementations.
message LogMatcher {
  // The field to match against
  LogFieldSelector field = 1;

  // Match type. Exactly one must be set.
  oneof match {
    // Exact string match
    string exact = 2;

    // Regular expression match
    string regex = 3;

    // Field existence check
    bool exists = 4;
  }

  // If true, inverts the match result
  bool negate = 5;
}

// =============================================================================
// Log Transform
// =============================================================================

// LogTransform defines modifications to logs.
message LogTransform {
  // Fields to remove
  repeated LogFieldSelector remove = 1;

  // Fields to redact
  repeated LogRedact redact = 2;

  // Fields to rename
  repeated LogRename rename = 3;

  // Fields to add
  repeated LogAdd add = 4;
}

// LogRedact masks a field value.
message LogRedact {
  // The field to redact
  LogFieldSelector field = 1;

  // Replacement value (e.g., "[REDACTED]")
  string replacement = 2;
}

// LogRename changes a field name.
message LogRename {
  // The field to rename
  LogFieldSelector from = 1;

  // The new field name
  string to = 2;

  // If true, overwrites the target field if it already exists
  bool upsert = 3;
}

// LogAdd inserts a field.
message LogAdd {
  // The field to add
  LogFieldSelector field = 1;

  // The value to set
  string value = 2;

  // If true, overwrites the field if it already exists
  bool upsert = 3;
}
