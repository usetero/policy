syntax = "proto3";

package tero.policy.v1;

option go_package = "github.com/usetero/policy/gen/go/tero/policy/v1";

// Policy represents a single telemetry processing rule.
message Policy {
  // Unique identifier for this policy.
  string id = 1;

  // Human-readable name.
  string name = 2;

  // Explanation of what this policy does and why it exists.
  string description = 3;

  // Whether this policy is active. Defaults to true.
  bool enabled = 4;

  // The target telemetry type and what to do with it.
  oneof target {
    LogTarget log = 10;
    MetricTarget metric = 11;
  }
}

// LogTarget defines matching and actions for log records.
message LogTarget {
  // Conditions that determine which logs this policy applies to.
  repeated LogMatchCondition match = 1;

  // Whether to keep or discard matching logs.
  // Values: "all" (default), "none", "N%", "N/s", "N/m"
  string keep = 2;

  // Transformations to apply to matching logs.
  LogTransform transform = 3;
}

// MetricTarget defines matching and actions for metrics.
message MetricTarget {
  // Conditions that determine which metrics this policy applies to.
  repeated MetricMatchCondition match = 1;

  // Whether to keep or discard matching metrics.
  // Values: "all" (default), "none", "N%", "N/s", "N/m"
  string keep = 2;

  // Transformations to apply to matching metrics.
  MetricTransform transform = 3;
}

// LogMatchCondition defines a single matching predicate for logs.
message LogMatchCondition {
  // The field to match against.
  // Valid fields: resource.*, severity_text, severity_number, body, attributes.*
  string field = 1;

  // Match type. Exactly one must be set.
  oneof match {
    string exact = 2;
    string regex = 3;
    bool exists = 4;
  }

  // If true, inverts the match result.
  bool negate = 5;
}

// MetricMatchCondition defines a single matching predicate for metrics.
message MetricMatchCondition {
  // The field to match against.
  // Valid fields: resource.*, name, attributes.*
  string field = 1;

  // Match type. Exactly one must be set.
  oneof match {
    string exact = 2;
    string regex = 3;
    bool exists = 4;
  }

  // If true, inverts the match result.
  bool negate = 5;
}

// LogTransform defines modifications to apply to logs.
// Substages execute in order: remove → redact → rename → add.
message LogTransform {
  // Fields to delete.
  repeated string remove = 1;

  // Fields to mask.
  repeated Redact redact = 2;

  // Fields to rename.
  repeated Rename rename = 3;

  // Fields to insert.
  repeated Add add = 4;
}

// MetricTransform defines modifications to apply to metrics.
// Substages execute in order: remove → redact → rename → add.
// Note: body is not valid for metrics.
message MetricTransform {
  // Attributes to delete.
  repeated string remove = 1;

  // Attributes to mask.
  repeated Redact redact = 2;

  // Attributes to rename.
  repeated Rename rename = 3;

  // Attributes to insert.
  repeated Add add = 4;
}

// Redact masks a field value.
message Redact {
  // The field to redact.
  string field = 1;

  // Replacement value. Defaults to "[REDACTED]".
  string replacement = 2;
}

// Rename changes a field key.
message Rename {
  // The original field name.
  string from = 1;

  // The new field name.
  string to = 2;
}

// Add inserts a new field.
message Add {
  // The field name to insert.
  string field = 1;

  // The value to insert.
  string value = 2;
}
