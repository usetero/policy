syntax = "proto3";

package tero.policy.v1;

option go_package = "github.com/usetero/policy/gen/go/tero/policy/v1";

// Policy is a single telemetry processing rule.
message Policy {
  string id = 1;
  string name = 2;
  string description = 3;
  bool enabled = 4;

  oneof target {
    LogTarget log = 10;
    MetricTarget metric = 11;
  }
}

// LogTarget defines matching and actions for logs.
message LogTarget {
  repeated MatchCondition match = 1;
  string keep = 2;
  LogTransform transform = 3;
}

// MetricTarget defines matching and actions for metrics.
message MetricTarget {
  repeated MatchCondition match = 1;
  string keep = 2;
  MetricTransform transform = 3;
}

// MatchCondition is a predicate for filtering telemetry.
message MatchCondition {
  string field = 1;
  bool negate = 5;

  oneof matcher {
    string exact = 2;
    string regex = 3;
    bool exists = 4;
  }
}

// LogTransform defines modifications to logs.
message LogTransform {
  repeated string remove = 1;
  repeated Redact redact = 2;
  repeated Rename rename = 3;
  repeated Add add = 4;
}

// MetricTransform defines modifications to metrics.
message MetricTransform {
  repeated string remove = 1;
  repeated Redact redact = 2;
  repeated Rename rename = 3;
  repeated Add add = 4;
}

// Redact masks a field value.
message Redact {
  string field = 1;
  string replacement = 2;
}

// Rename changes a field name.
message Rename {
  string from = 1;
  string to = 2;
}

// Add inserts a field.
message Add {
  string field = 1;
  string value = 2;
}
